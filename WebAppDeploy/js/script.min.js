const _port=8189,url="http://localhost:8189/";let platform,maptypes,map,kioskList=[],signUpBtn=document.getElementById("signUpButton"),signUpBck=document.getElementById("backBtn"),startBtn=document.getElementById("startBtn"),accountBtn=document.getElementById("accountBtn"),rckBtn=document.getElementById("rckBtn"),pwdChngBtn=document.getElementById("pwdChngBtn"),storeBtn=document.getElementById("storeBtn"),cartBtn=document.getElementById("cart-tab"),createAccountBtn=document.getElementById("createAccountBtn"),loginBtn=document.getElementById("loginButton"),logOutBtn=document.getElementById("logOutButton"),pwdChgBtn=document.getElementById("pwdChgBtn"),mainHeader=document.getElementById("mainHeader"),recycleUnlkBtn=document.getElementById("unlockRecycleBtn"),upcycleUnlkBtn=document.getElementById("unlockUpcycleBtn"),donateUnlkBtn=document.getElementById("unlockDonateBtn"),accountContent=document.getElementById("account-tab"),loading=document.getElementById("loading"),tops=[],pants=[],jackets=[],accessories=[],cart=[],topsContent=document.getElementById("tops"),pantsContent=document.getElementById("pants"),jacketsContent=document.getElementById("jackets"),accessoriesContent=document.getElementById("accessories"),cartContent=document.getElementById("cart"),accountName=document.getElementById("accountName"),accountEmail=document.getElementById("accountEmail"),newPasswordInput=document.getElementById("newPasswordInput"),newUserPassword=document.getElementById("newUserPassword"),olderPassword=document.getElementById("olderPassword"),cancelChgBtn=document.getElementById("cancelChgBtn"),passUpdateStatus=document.getElementById("passUpdateStatus"),signUpFirstName=document.getElementById("signUpFirstName"),signUpLastName=document.getElementById("signUpLastName"),signUpUserName=document.getElementById("signUpUserName"),registerPass=document.getElementById("registerPass"),signUpEmail=document.getElementById("signUpEmail"),statusMsg=document.getElementById("statusMsg"),userInputEmail=document.getElementById("userInputEmail"),userInputPassword=document.getElementById("userInputPass"),recycleCard=document.getElementById("recycleCard"),upcycleCard=document.getElementById("upcycleCard"),donateCard=document.getElementById("donateCard"),recycleNotif=document.getElementById("recycleNotif"),upcycleNotif=document.getElementById("upcycleNotif"),donateNotif=document.getElementById("donateNotif"),recycleIcon=document.getElementById("recycleIcon"),upcycleIcon=document.getElementById("upcycleIcon"),donateIcon=document.getElementById("donateIcon"),loggedUsername="",loggedFirstName="",loggedLastName="",loggedEmail="",loggedPoints=0,loggedRecycle=0,loggedUpcycle=0,loggedDonation=0;function init(){platform=new H.service.Platform({apikey:"bjkfk3pJqU3BF9q5_wxtcx5M03kpRxaUUsKOlFG18FA"}),maptypes=platform.createDefaultLayers(),loginBtn.addEventListener("click",()=>{loginUser()}),logOutBtn.addEventListener("click",()=>{accountPopulate({Username:"",Firstname:"",Lastname:"",Points:0,Upcycle:0,Recylce:0}),carouselSlideTo(1),logToggle()}),pwdChgBtn.addEventListener("click",()=>{changePassword()}),cancelChgBtn.addEventListener("click",()=>{newPasswordInput.classList.toggle("d-none"),cancelChgBtn.classList.toggle("d-none")}),signUpBtn.addEventListener("click",()=>{signUpToggle()}),signUpBck.addEventListener("click",()=>{signUpToggle(),clearRegistration()}),startBtn.addEventListener("click",()=>{getLocation()}),accountBtn.addEventListener("click",()=>{passUpdateStatus.classList.add("d-none"),carouselSlideTo(2)}),rckBtn.addEventListener("click",()=>{carouselSlideTo(1)}),storeBtn.addEventListener("click",()=>{carouselSlideTo(0)}),document.getElementById("cart-tab").addEventListener("click",()=>{refreshCart()}),createAccountBtn.addEventListener("click",()=>{validatePassword()}),document.getElementById("mapModalCloseBtn").addEventListener("click",()=>{updateRecycleButtons(0)}),document.getElementById("selectRecycleOption").addEventListener("click",()=>{updateLockerCards()}),recycleUnlkBtn.addEventListener("click",()=>{updateRecycleButtons(1)}),upcycleUnlkBtn.addEventListener("click",()=>{updateRecycleButtons(2)}),donateUnlkBtn.addEventListener("click",()=>{updateRecycleButtons(3)}),getStore()}function carouselSlideTo(e){switch($(".carousel").carousel(e),storeBtn.setAttribute("class","nav-link text-secondary"),rckBtn.setAttribute("class","nav-link text-secondary"),accountBtn.setAttribute("class","nav-link text-secondary"),e){case 0:storeBtn.setAttribute("class","nav-link text-primary");break;case 1:rckBtn.setAttribute("class","nav-link text-primary");break;case 2:accountBtn.setAttribute("class","nav-link text-primary")}}function registerUser(){let e=url+"api/users/register",t={Username:signUpUserName.value,Firstname:signUpFirstName.value,Lastname:signUpLastName.value,Password:registerPass.value,Email:signUpEmail.value,Points:0,Recylce:0,Upcycle:0,Donate:0},n=new XMLHttpRequest;n.onreadystatechange=function(){4==this.readyState&&200==this.status?(signUpToggle(),clearRegistration()):registerError(this.responseText)},n.open("POST",e,!0),n.setRequestHeader("Content-Type","application/json;charset=UTF-8"),n.send(JSON.stringify(t))}function loginUser(){let e=url+"api/users/login?Email="+userInputEmail.value,t=new XMLHttpRequest;t.open("GET",e,!0),t.setRequestHeader("Authorization","Basic "+btoa(userInputEmail.value+":"+userInputPassword.value)),t.setRequestHeader("Content-Type","application/json; charset=utf-8"),t.send(null),t.onload=function(){if(200!=t.status)registerError("Incorrect Credentials");else{let e=JSON.parse(t.responseText);loggedEmail=userInputEmail.value,accountPopulate(e),successfulLogin()}}}function updatePassword(e){let t=url+"api/users/update",n=new XMLHttpRequest;n.open("POST",t,!0),n.withCredentials=!0,n.setRequestHeader("Content-Type","application/json; charset=utf-8"),n.setRequestHeader("Authorization","Basic "+btoa(loggedEmail+":"+olderPassword.value)),n.send(e),n.onload=function(){200!=n.status?showUpdateStatus("Wrong Password"):(updateSuccess(),showUpdateStatus("Update Success"))}}function getLocation(){navigator.geolocation?(document.getElementById("start-tab").classList.toggle("d-none"),loading.classList.toggle("d-none"),navigator.geolocation.getCurrentPosition(showMap)):console.log("Geolocation is not supported by this browser.")}function showMap(e){map=new H.Map(document.getElementById("mapContainer"),maptypes.vector.normal.map,{zoom:16,center:{lng:e.coords.longitude,lat:e.coords.latitude},pixelRatio:window.devicePixelRatio||1});let t=H.ui.UI.createDefault(map,maptypes);t.removeControl("mapsettings"),window.addEventListener("resize",()=>map.getViewPort().resize());new H.mapevents.Behavior(new H.mapevents.MapEvents(map));let n=new H.map.Icon("imgs/my_location-24px.svg"),s=new H.map.Marker({lat:e.coords.latitude,lng:e.coords.longitude},{icon:n});map.addObject(s);const a=new XMLHttpRequest,c=url+"api/kiosk/kiosks";a.open("GET",c,!0),a.onload=(()=>{const e=JSON.parse(a.responseText);if(0!=e.length){let n=new H.map.Icon("imgs/rck_location-24px.svg"),s=new H.map.Group;s.addEventListener("tap",e=>{let n=new H.ui.InfoBubble(e.target.getGeometry(),{content:e.target.getData()});t.addBubble(n)},!1);for(let t=0;t<e.length;t++){let a=new H.map.Marker({lng:e[t].Longitude,lat:e[t].Latitude},{icon:n});a.setData('<button type="button" onmousedown="mapModalData('+t+')" class="map-modal btn btn-sm btn-link bubble-text text-decoration-none" data-toggle="modal" data-target="#mapModal">'+e[t].Name+'<p class="font-weight-light text-tiny address-text">'+e[t].Address.split(",")[0]+"</p></button>"),s.addObject(a),kioskList.push(e[t])}console.log(e),map.addObject(s)}loading.classList.toggle("d-none")}),a.send(null)}function mapModalData(e){document.getElementById("mapModalLabel").innerText=kioskList[e].Name}function updateLockerCards(){console.log("t"),document.getElementById("recycleCheck").checked?recycleCard.setAttribute("class","card"):recycleCard.setAttribute("class","card d-none"),document.getElementById("upcycleCheck").checked?upcycleCard.setAttribute("class","card"):upcycleCard.setAttribute("class","card d-none"),document.getElementById("donateCheck").checked?donateCard.setAttribute("class","card"):donateCard.setAttribute("class","card d-none")}function updateRecycleButtons(e){switch(e){case 0:recycleUnlkBtn.setAttribute("class","btn btn-success w-100"),upcycleUnlkBtn.setAttribute("class","btn btn-success w-100"),donateUnlkBtn.setAttribute("class","btn btn-success w-100"),recycleNotif.innerText="",upcycleNotif.innerText="",donateNotif.innerText="",recycleIcon.innerText="lock",upcycleIcon.innerText="lock",donateIcon.innerText="lock",document.getElementById("recycleCheck").checked=!1,document.getElementById("upcycleCheck").checked=!1,document.getElementById("donateCheck").checked=!1,$("#collapseOne").collapse("show"),$("#collapseTwo").collapse("hide");break;case 1:recycleUnlkBtn.setAttribute("class","btn btn-success w-100 disabled"),recycleNotif.innerText="Locker will automatically lock when closed",recycleIcon.innerText="lock_open";break;case 2:upcycleUnlkBtn.setAttribute("class","btn btn-success w-100 disabled"),upcycleNotif.innerText="Locker will automatically lock when closed",upcycleIcon.innerText="lock_open";break;case 3:donateUnlkBtn.setAttribute("class","btn btn-success w-100 disabled"),donateNotif.innerText="Locker will automatically lock when closed",donateIcon.innerText="lock_open"}}function getStore(){const e=new XMLHttpRequest,t=url+"api/shop/list";e.open("GET",t,!0),e.onload=(()=>{const t=JSON.parse(e.responseText);if(0!=t.length){for(let e=0;e<t.length;e++)switch(t[e].CategoryID){case 1:tops.push(t[e]);break;case 2:pants.push(t[e]);break;case 3:jackets.push(t[e]);break;case 4:accessories.push(t[e])}displayShopItems(document.getElementById("tops"),tops),displayShopItems(document.getElementById("pants"),pants),displayShopItems(document.getElementById("jackets"),jackets),displayShopItems(document.getElementById("accessories"),accessories)}}),e.send(null)}function displayShopItems(e,t){let n='<div class="row">';for(let e=0;e<t.length;e++)n+='<div class="col-md-4 col-6"><div class="card"><img src="imgs/'+t[e].ShopImg+'" class="card-img-top" alt="'+t[e].Name+'"><div class="card-body"><span class="text-tiny text-secondary">ID #'+t[e].ProductID+'</span><p class="card-text">'+t[e].Name+'</p><p class="card-text"> Size: '+t[e].Size+'</p><button type="button" onmousedown="shopModalData('+t[e].CategoryID+","+e+')" class="btn btn-primary" data-toggle="modal" data-target="#shopModal"> View Item </button></div></div></div>';n+="</div>",e.innerHTML=n}function selectItem(e,t){switch(e){case 1:return tops[t];case 2:return pants[t];case 3:return jackets[t];case 4:return accessories[t]}}function shopModalData(e,t){let n=selectItem(e,t);document.getElementById("shop-item-title").innerText=n.Name,document.getElementById("shop-item-img").setAttribute("src","imgs/"+n.ShopImg),document.getElementById("shop-item-name").innerText=n.Name,document.getElementById("shop-item-id").innerText="ID #"+n.ProductID;let s=document.getElementById("shop-item-stock");s.innerText="Stock: "+n.Stock;let a=document.getElementById("shop-item-quantity"),c="";for(let e=1;e<=n.Stock;e++)c+='<option value="'+e+'">'+e+"</option>";a.innerHTML=c;let o=document.getElementById("add-to-cart");n.Stock>0?(s.setAttribute("class","text-secondary"),o.setAttribute("class","btn btn-primary"),o.setAttribute("data-dismiss","modal"),o.innerText="Add to Cart",o.setAttribute("onmousedown","addToCart("+e+","+t+","+a.value+");")):(s.setAttribute("class","text-danger"),o.setAttribute("class","btn btn-danger disabled"),o.removeAttribute("data-dismiss"),o.innerText="Out of Stock",o.removeAttribute("onmousedown")),document.getElementById("shop-item-desc").innerText=n.Description}function addToCart(e,t){let n=selectItem(e,t),s=document.getElementById("shop-item-quantity"),a=document.getElementById("shop-alert");for(let e=0;e<cart.length;e++)if(n.ProductID==cart[e].ProductID)return a.setAttribute("class","alert alert-danger text-center"),void(a.innerText="That item is already in your cart!");n.Quantity=Number(s.value),cart.push(n),a.setAttribute("class","alert alert-success text-center"),a.innerText="Added "+s.value+" "+n.Name+" "+n.Size+" to your cart",refreshCart()}function removeFromCart(e){let t=[],n=document.getElementById("shop-alert");n.setAttribute("class","alert alert-danger text-center"),n.innerText="Removed "+cart[e].Name+" from your cart";for(let n=0;n<cart.length;n++)e!=n&&t.push(cart[n]);cart=t,refreshCart()}function refreshCart(){cartItems='<div class="row">';for(let e=0;e<cart.length;e++)cartItems+='<div class="col-6 col-md-4"><div class="card"><img src="imgs/'+cart[e].ShopImg+'" class="card-img-top" alt="'+cart[e].Name+'"><div class="card-body"><span class="text-tiny text-secondary">ID #'+cart[e].ProductID+'</span><p class="card-text">'+cart[e].Name+'</p><p class="card-text"> Size: '+cart[e].Size+"</p><p><label>Quantity: "+cart[e].Quantity+'</p><button type="button" onmousedown="removeFromCart('+e+')" class="btn btn-danger"> Remove Item </button></div></div></div>';0==cart.length&&(cartItems="You're cart is empty! Add some stuff to it!"),cartItems+="</div>",document.getElementById("cart").innerHTML=cartItems}function successfulLogin(){logToggle()}function logToggle(){let e=document.getElementById("mainApp"),t=document.getElementById("logInScreen"),n=document.getElementById("footNav");e.classList.toggle("d-none"),t.classList.toggle("d-none"),n.classList.toggle("d-none")}function accountPopulate(e){loggedUsername=e.Username,loggedFirstname=e.Firstname,loggedLastName=e.Lastname,loggedPoints=e.Points,loggedUpcycle=e.Upcycle,loggedRecycle=e.Recycle,loggedDonation=e.Donate,accountPageUpdate()}function accountPageUpdate(){accountName.innerHTML=`${loggedFirstname} ${loggedLastName}`,accountEmail.innerHTML=`${loggedEmail}`}function signUpToggle(){let e=document.getElementById("logIn"),t=document.getElementById("signUp");e.classList.toggle("d-none"),t.classList.toggle("d-none"),e.classList.contains("d-none")?(statusMsg.innerHTML="Create Account to Log In",statusMsg.classList.remove("text-danger")):(statusMsg.classList.add("text-dark"),statusMsg.innerHTML="Log In to complete your order")}function registerError(e){statusMsg.innerHTML=e,statusMsg.classList.add("text-danger")}function clearRegistration(){signUpFirstName.value="",signUpLastName.value="",signUpUserName.value="",registerPass.value="",signUpEmail.value=""}function showUpdateStatus(e){passUpdateStatus.classList.remove("d-none"),passUpdateStatus.innerHTML=e,"Update Success"==e?(passUpdateStatus.classList.add("text-success"),passUpdateStatus.classList.remove("text-danger")):(passUpdateStatus.classList.remove("text-success"),passUpdateStatus.classList.add("text-danger"))}function validatePassword(){registerPass.value.match(/^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])([a-zA-Z0-9]{8,})$/)?registerUser():registerError("Sorry Password must be atleast 8 charcters, one lower cased character, one upper cased character and atleast one number")}function updateSuccess(){olderPassword.value="",newUserPassword.value="",newPasswordInput.classList.toggle("d-none"),cancelChgBtn.classList.toggle("d-none")}function changePassword(){if(newPasswordInput.classList.contains("d-none"))newPasswordInput.classList.toggle("d-none"),cancelChgBtn.classList.toggle("d-none");else{let e={Username:loggedUsername,Firstname:loggedFirstname,Lastname:loggedLastName,Password:newUserPassword.value,Email:loggedEmail,Points:loggedPoints,Recylce:loggedRecycle,Upcycle:loggedUpcycle,Donate:loggedDonation};updatePassword(JSON.stringify(e))}}init();